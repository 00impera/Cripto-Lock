import React, { useState, useEffect } from "react";
import {
  ThirdwebProvider,
  ConnectButton,
  useActiveAccount,
  useActiveWallet,
  useChain,
  useReadContract,
  useSendTransaction,
  TransactionButton,
} from "thirdweb/react";
import { getContract } from "thirdweb";
import { erc20 } from "thirdweb/extensions";
import { ethereum } from "thirdweb/chains";

// Replace with your actual contract addresses
const LOCKER_CONTRACT = "0x82ecB5c11Eda49f8E77e8617C360A5645F8612D1";
const LOCKER_ABI = [
  /* ...your ABI here... */
];

function LockerApp() {
  const account = useActiveAccount();
  const wallet = useActiveWallet();
  const chain = useChain();
  const [tokenAddress, setTokenAddress] = useState("");
  const [amount, setAmount] = useState("");
  const [duration, setDuration] = useState("2592000");
  const [tokenContract, setTokenContract] = useState(null);
  const [lockerContract, setLockerContract] = useState(null);
  const [tokenDecimals, setTokenDecimals] = useState(18);
  const [tokenSymbol, setTokenSymbol] = useState("");
  const [tokenBalance, setTokenBalance] = useState("");
  const [ethBalance, setEthBalance] = useState("");
  const [status, setStatus] = useState("");
  const [locks, setLocks] = useState([]);

  // Setup contracts
  useEffect(() => {
    if (tokenAddress && account) {
      getContract({
        client: wallet?.client,
        address: tokenAddress,
        chain: ethereum,
      }).then(async (contract) => {
        setTokenContract(contract);
        try {
          const decimals = await erc20.decimals({ contract });
          setTokenDecimals(Number(decimals));
          const symbol = await erc20.symbol({ contract });
          setTokenSymbol(symbol);
        } catch {
          setTokenDecimals(18);
          setTokenSymbol("");
        }
      });
    }
  }, [tokenAddress, account, wallet]);

  useEffect(() => {
    if (account) {
      getContract({
        client: wallet?.client,
        address: LOCKER_CONTRACT,
        chain: ethereum,
        abi: LOCKER_ABI,
      }).then(setLockerContract);
    }
  }, [account, wallet]);

  // Fetch balances
  useEffect(() => {
    async function fetchBalances() {
      if (account && tokenContract) {
        try {
          const bal = await erc20.balanceOf({
            contract: tokenContract,
            address: account.address,
          });
          setTokenBalance(
            (Number(bal) / 10 ** tokenDecimals).toFixed(4) + " " + tokenSymbol,
          );
        } catch {
          setTokenBalance("");
        }
      }
      if (account && wallet) {
        try {
          const bal = await wallet.getBalance();
          setEthBalance((Number(bal) / 1e18).toFixed(4) + " ETH");
        } catch {
          setEthBalance("");
        }
      }
    }
    fetchBalances();
  }, [account, tokenContract, tokenDecimals, tokenSymbol, wallet]);

  // Fetch locks
  useEffect(() => {
    async function fetchLocks() {
      if (lockerContract && account) {
        try {
          const locks = await lockerContract.read.getLocks([account.address]);
          setLocks(locks);
        } catch {
          setLocks([]);
        }
      }
    }
    fetchLocks();
  }, [lockerContract, account]);

  // Approve tokens
  const approveTx = tokenContract
    ? () =>
        erc20.approve({
          contract: tokenContract,
          spender: LOCKER_CONTRACT,
          amount: BigInt(Number(amount) * 10 ** tokenDecimals),
        })
    : undefined;

  // Lock tokens
  const lockTokensTx =
    lockerContract && tokenContract
      ? () =>
          lockerContract.write.lock([
            tokenAddress,
            BigInt(Number(amount) * 10 ** tokenDecimals),
            BigInt(duration),
          ])
      : undefined;

  return (
    <div
      style={{
        maxWidth: 600,
        margin: "40px auto",
        background: "#111",
        borderRadius: 24,
        padding: 32,
        color: "#fff",
      }}
    >
      <h2>
        ‚¨¢ CRYPTOLOCKER{" "}
        <span
          style={{
            background: "#10b981",
            color: "#fff",
            borderRadius: 8,
            padding: "4px 12px",
            marginLeft: 8,
          }}
        >
          MAINNET
        </span>
      </h2>
      <div style={{ margin: "24px 0" }}>
        <ConnectButton />
        {account && (
          <div style={{ marginTop: 12 }}>
            üîê Connected:{" "}
            <b>
              {account.address.slice(0, 6)}...{account.address.slice(-4)}
            </b>
          </div>
        )}
      </div>
      <input
        placeholder="Token Contract Address (0x...)"
        value={tokenAddress}
        onChange={(e) => setTokenAddress(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 12,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      />
      <div style={{ fontSize: 13, color: "#999", marginBottom: 8 }}>
        {tokenBalance}
      </div>
      <input
        placeholder="Amount (e.g., 1)"
        value={amount}
        onChange={(e) => setAmount(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 12,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      />
      <div style={{ fontSize: 13, color: "#999", marginBottom: 8 }}>
        {ethBalance}
      </div>
      <select
        value={duration}
        onChange={(e) => setDuration(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 18,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      >
        <option value="2592000">‚è± 30 Days (Minimum)</option>
        <option value="7776000">‚è± 90 Days</option>
        <option value="15552000">‚è± 180 Days</option>
        <option value="31536000">‚è± 1 Year</option>
      </select>
      <h3>üîí Locking Options</h3>
      <TransactionButton
        transaction={approveTx}
        onTransactionConfirmed={() => setStatus("‚úÖ Tokens approved!")}
        style={{ marginBottom: 12 }}
      >
        ‚úÖ Approve Tokens
      </TransactionButton>
      <TransactionButton
        transaction={lockTokensTx}
        onTransactionConfirmed={() => setStatus("‚úÖ Tokens locked!")}
        style={{ marginBottom: 12 }}
      >
        üîí Lock Tokens
      </TransactionButton>
      {status && (
        <div style={{ margin: "12px 0", color: "#10b981" }}>{status}</div>
      )}
      <h3>üìã Your Locks</h3>
      <div
        style={{
          background: "#1a1a1a",
          borderRadius: 12,
          padding: 16,
          minHeight: 60,
        }}
      >
        {locks && locks.length > 0
          ? locks.map((lock, i) => (
              <div key={i} style={{ marginBottom: 12 }}>
                <b>Token:</b> {lock.token} <br />
                <b>Amount:</b>{" "}
                {(Number(lock.amount) / 10 ** tokenDecimals).toFixed(4)}{" "}
                {tokenSymbol} <br />
                <b>Start:</b>{" "}
                {new Date(Number(lock.start) * 1000).toLocaleString()} <br />
                <b>Duration:</b> {Number(lock.duration) / 86400} days <br />
                <b>Status:</b> {lock.claimed ? "Unlocked" : "Locked"}
              </div>
            ))
          : "No locks found."}
      </div>
    </div>
  );
}

// Wrap with provider
export default function App() {
  return (
    <ThirdwebProvider clientId="YOUR_CLIENT_ID" supportedChains={[ethereum]}>
      <LockerApp />
    </ThirdwebProvider>
  );
}
