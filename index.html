import React, { useState, useEffect } from "react";
import {
  ThirdwebProvider,
  ConnectButton,
  useActiveAccount,
  TransactionButton,
} from "thirdweb/react";
import { getContract } from "thirdweb";
import { erc20 } from "thirdweb/extensions";
import { ethereum } from "thirdweb/chains";

// Your ABI here (paste the full array)
const LOCKER_ABI = [
  // ...PASTE YOUR ABI HERE...
];
const LOCKER_ADDRESS = "0x82ecB5c11Eda49f8E77e8617C360A5645F8612D1";

function LockerApp() {
  const account = useActiveAccount();
  const [tokenAddress, setTokenAddress] = useState("");
  const [amount, setAmount] = useState("");
  const [duration, setDuration] = useState("2592000");
  const [tokenContract, setTokenContract] = useState(null);
  const [lockerContract, setLockerContract] = useState(null);
  const [tokenDecimals, setTokenDecimals] = useState(18);
  const [tokenSymbol, setTokenSymbol] = useState("");
  const [tokenBalance, setTokenBalance] = useState("");
  const [status, setStatus] = useState("");
  const [profitRate, setProfitRate] = useState(null);

  // Setup contracts
  useEffect(() => {
    if (tokenAddress && account) {
      getContract({
        client: account.client,
        address: tokenAddress,
        chain: ethereum,
      }).then(async (contract) => {
        setTokenContract(contract);
        try {
          const decimals = await erc20.decimals({ contract });
          setTokenDecimals(Number(decimals));
          const symbol = await erc20.symbol({ contract });
          setTokenSymbol(symbol);
        } catch {
          setTokenDecimals(18);
          setTokenSymbol("");
        }
      });
    }
  }, [tokenAddress, account]);

  useEffect(() => {
    if (account) {
      getContract({
        client: account.client,
        address: LOCKER_ADDRESS,
        chain: ethereum,
        abi: LOCKER_ABI,
      }).then(async (contract) => {
        setLockerContract(contract);
        try {
          const rate = await contract.read.profitRate();
          setProfitRate(rate.toString());
        } catch {
          setProfitRate(null);
        }
      });
    }
  }, [account]);

  // Fetch balances
  useEffect(() => {
    async function fetchBalances() {
      if (account && tokenContract) {
        try {
          const bal = await erc20.balanceOf({
            contract: tokenContract,
            address: account.address,
          });
          setTokenBalance(
            (Number(bal) / 10 ** tokenDecimals).toFixed(4) + " " + tokenSymbol,
          );
        } catch {
          setTokenBalance("");
        }
      }
    }
    fetchBalances();
  }, [account, tokenContract, tokenDecimals, tokenSymbol]);

  // Approve tokens
  const approveTx = tokenContract
    ? () =>
        erc20.approve({
          contract: tokenContract,
          spender: LOCKER_ADDRESS,
          amount: BigInt(Number(amount) * 10 ** tokenDecimals),
        })
    : undefined;

  // Lock tokens
  const lockTokensTx =
    lockerContract && tokenContract
      ? () =>
          lockerContract.write.lock([
            tokenAddress,
            BigInt(Number(amount) * 10 ** tokenDecimals),
            BigInt(duration),
          ])
      : undefined;

  return (
    <div
      style={{
        maxWidth: 500,
        margin: "40px auto",
        background: "#111",
        borderRadius: 24,
        padding: 32,
        color: "#fff",
      }}
    >
      <h2>
        ‚¨¢ CRYPTOLOCKER{" "}
        <span
          style={{
            background: "#10b981",
            color: "#fff",
            borderRadius: 8,
            padding: "4px 12px",
            marginLeft: 8,
          }}
        >
          MAINNET
        </span>
      </h2>
      <div style={{ margin: "24px 0" }}>
        <ConnectButton />
        {account && (
          <div style={{ marginTop: 12 }}>
            üîê Connected:{" "}
            <b>
              {account.address.slice(0, 6)}...{account.address.slice(-4)}
            </b>
          </div>
        )}
      </div>
      <input
        placeholder="Token Contract Address (0x...)"
        value={tokenAddress}
        onChange={(e) => setTokenAddress(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 12,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      />
      <div style={{ fontSize: 13, color: "#999", marginBottom: 8 }}>
        {tokenBalance}
      </div>
      <input
        placeholder="Amount (e.g., 1)"
        value={amount}
        onChange={(e) => setAmount(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 12,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      />
      <select
        value={duration}
        onChange={(e) => setDuration(e.target.value)}
        style={{
          width: "100%",
          marginBottom: 18,
          padding: 12,
          borderRadius: 8,
          border: "1px solid #333",
          background: "#1a1a1a",
          color: "#fff",
        }}
      >
        <option value="2592000">‚è± 30 Days (Minimum)</option>
        <option value="7776000">‚è± 90 Days</option>
        <option value="15552000">‚è± 180 Days</option>
        <option value="31536000">‚è± 1 Year</option>
      </select>
      <div style={{ marginBottom: 12 }}>
        {profitRate && (
          <span style={{ color: "#10b981" }}>Profit Rate: {profitRate}</span>
        )}
      </div>
      <TransactionButton
        transaction={approveTx}
        onTransactionConfirmed={() => setStatus("‚úÖ Tokens approved!")}
        onError={(err) => setStatus("‚ùå " + err.message)}
        style={{ marginBottom: 12 }}
      >
        ‚úÖ Approve Tokens
      </TransactionButton>
      <TransactionButton
        transaction={lockTokensTx}
        onTransactionConfirmed={() => setStatus("‚úÖ Tokens locked!")}
        onError={(err) => setStatus("‚ùå " + err.message)}
        style={{ marginBottom: 12 }}
      >
        üîí Lock Tokens
      </TransactionButton>
      {status && (
        <div
          style={{
            margin: "12px 0",
            color: status.startsWith("‚úÖ") ? "#10b981" : "#ef4444",
          }}
        >
          {status}
        </div>
      )}
    </div>
  );
}

export default function App() {
  return (
    <ThirdwebProvider
      clientId="10f433657d1018e7003e5cd1cb9c61d7"
      supportedChains={[ethereum]}
    >
      <LockerApp />
    </ThirdwebProvider>
  );
}
